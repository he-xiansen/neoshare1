{% extends 'new_base.html' %}

{% block content %}
    <div class="card">
        <h2>æ¬¢è¿ä½¿ç”¨ NeoShare</h2>
        <p>è½»é‡çº§æ–‡ä»¶å…±äº«å¹³å°ï¼Œæ— éœ€ç™»å½•å³å¯ä¸Šä¼ å’Œä¸‹è½½å…¬å…±æ–‡ä»¶ã€‚</p>
    </div>

    <!-- å…¬å…±æ–‡ä»¶ä¸Šä¼  -->
    <div class="card">
        <h3>ä¸Šä¼ å…¬å…±æ–‡ä»¶</h3>
        <form method="POST" action="/upload" enctype="multipart/form-data" class="upload-form">
            <div id="drag-drop-area" style="border: 2px dashed var(--accent-purple); border-radius: 10px; padding: 3rem; text-align: center; margin-bottom: 1rem; transition: all 0.3s ease;">
                <label for="file-upload" class="upload-label">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„
                </label>
                <input type="file" id="file-upload" name="file" required style="display: none;">
                <div id="file-info" style="margin: 1rem 0; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 5px; display: none;">
                    <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong>
                    <span id="selected-filename"></span>
                </div>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">ä¸Šä¼ æ–‡ä»¶</button>
        </form>
    </div>

    <script>
        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        const dragDropArea = document.getElementById('drag-drop-area');
        const fileInput = document.getElementById('file-upload');
        const fileInfo = document.getElementById('file-info');
        const selectedFilename = document.getElementById('selected-filename');
        
        if (dragDropArea && fileInput && fileInfo && selectedFilename) {
            // æ‹–æ‹½äº‹ä»¶å¤„ç†
            dragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragDropArea.style.borderColor = 'var(--accent-pink)';
                dragDropArea.style.backgroundColor = 'rgba(255, 107, 157, 0.1)';
            });
            
            dragDropArea.addEventListener('dragleave', () => {
                dragDropArea.style.borderColor = 'var(--accent-purple)';
                dragDropArea.style.backgroundColor = 'transparent';
            });
            
            dragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragDropArea.style.borderColor = 'var(--accent-purple)';
                dragDropArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    fileInput.files = e.dataTransfer.files;
                    selectedFilename.textContent = file.name;
                    fileInfo.style.display = 'block';
                }
            });
            
            // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
            dragDropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    selectedFilename.textContent = file.name;
                    fileInfo.style.display = 'block';
                } else {
                    selectedFilename.textContent = '';
                    fileInfo.style.display = 'none';
                }
            });
        }
    </script>

    <!-- å…¬å…±æ–‡ä»¶åˆ—è¡¨ -->
    <div class="card">
        <h3>å…¬å…±æ–‡ä»¶</h3>
        <div class="file-list">
            {% for file in public_files %}
                <div class="file-item">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-name">{{ file.filename }}</div>
                    <div class="file-meta">
                        <p>å¤§å°: {{ (file.file_size / 1024)|round(2) }} KB</p>
                        <p>ä¸Šä¼ æ—¶é—´: {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                    <div class="file-actions">
                        {% set ext = file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else '' %}
                        {% set editable_ext = ['txt', 'md', 'markdown', 'py', 'js', 'html', 'css', 'json', 'xml', 'yaml', 'yml', 'sh', 'bat', 'cmd', 'java', 'c', 'cpp', 'h', 'hpp', 'php', 'rb', 'go', 'rust', 'swift', 'kt'] %}
                        {% set archive_ext = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz'] %}
                        
                        {% if ext in archive_ext %}
                            <!-- å‹ç¼©åŒ…åªæ˜¾ç¤ºä¸‹è½½æŒ‰é’® -->
                            <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">ä¸‹è½½</a>
                        {% elif ext in editable_ext %}
                            <!-- å¯ç¼–è¾‘æ–‡ä»¶æ˜¾ç¤ºç¼–è¾‘æŒ‰é’® -->
                            <a href="{{ url_for('edit_file', file_id=file.id) }}" class="btn btn-primary">ç¼–è¾‘</a>
                            <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-success">ä¸‹è½½</a>
                        {% else %}
                            <!-- å…¶ä»–æ–‡ä»¶æ˜¾ç¤ºé¢„è§ˆå’Œä¸‹è½½æŒ‰é’® -->
                            <a href="{{ url_for('preview_file', file_id=file.id) }}" class="btn btn-secondary">é¢„è§ˆ</a>
                            <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">ä¸‹è½½</a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
