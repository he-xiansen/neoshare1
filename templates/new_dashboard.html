{% extends 'new_base.html' %}

{% block content %}
    <!-- ÊêúÁ¥¢Ê°Ü -->
    <div class="search-container">
        <form method="GET" action="{{ url_for('search') }}" style="width: 100%; display: flex; gap: 1rem;">
            <input type="text" name="q" placeholder="ÊêúÁ¥¢Êñá‰ª∂..." class="search-input" value="{{ request.args.get('q', '') }}">
            <button type="submit" class="btn btn-primary">ÊêúÁ¥¢</button>
        </form>
    </div>

    <!-- Êñá‰ª∂‰∏ä‰º† -->
    <div class="card">
        <h3>‰∏ä‰º†Êñá‰ª∂</h3>
        <form method="POST" action="/upload" enctype="multipart/form-data" class="upload-form">
            <div id="drag-drop-area" style="border: 2px dashed var(--accent-purple); border-radius: 10px; padding: 3rem; text-align: center; margin-bottom: 1rem; transition: all 0.3s ease;">
                <label for="file-upload" class="upload-label">
                    üìÅ ÈÄâÊã©Êñá‰ª∂ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ
                </label>
                <input type="file" id="file-upload" name="file" required style="display: none;">
                <div id="file-info" style="margin: 1rem 0; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 5px; display: none;">
                    <strong>Â∑≤ÈÄâÊã©Êñá‰ª∂Ôºö</strong>
                    <span id="selected-filename"></span>
                </div>
            </div>
            <br>
            <div class="checkbox-container">
                <input type="checkbox" id="is-public" name="is_public">
                <label for="is-public">ËÆæ‰∏∫ÂÖ¨ÂÖ±Êñá‰ª∂</label>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">‰∏ä‰º†Êñá‰ª∂</button>
        </form>
    </div>

    <script>
        // ÊãñÊãΩ‰∏ä‰º†ÂäüËÉΩ
        const dragDropArea = document.getElementById('drag-drop-area');
        const fileInput = document.getElementById('file-upload');
        const fileInfo = document.getElementById('file-info');
        const selectedFilename = document.getElementById('selected-filename');
        
        if (dragDropArea && fileInput && fileInfo && selectedFilename) {
            // ÊãñÊãΩ‰∫ã‰ª∂Â§ÑÁêÜ
            dragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragDropArea.style.borderColor = 'var(--accent-pink)';
                dragDropArea.style.backgroundColor = 'rgba(255, 107, 157, 0.1)';
            });
            
            dragDropArea.addEventListener('dragleave', () => {
                dragDropArea.style.borderColor = 'var(--accent-purple)';
                dragDropArea.style.backgroundColor = 'transparent';
            });
            
            dragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragDropArea.style.borderColor = 'var(--accent-purple)';
                dragDropArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    fileInput.files = e.dataTransfer.files;
                    selectedFilename.textContent = file.name;
                    fileInfo.style.display = 'block';
                }
            });
            
            // ÁÇπÂáªÈÄâÊã©Êñá‰ª∂
            dragDropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    selectedFilename.textContent = file.name;
                    fileInfo.style.display = 'block';
                } else {
                    selectedFilename.textContent = '';
                    fileInfo.style.display = 'none';
                }
            });
        }
    </script>

    <!-- ‰∏™‰∫∫Êñá‰ª∂ÂàóË°® -->
    <div class="card">
        <h3>ÊàëÁöÑÊñá‰ª∂</h3>
        <div class="file-list">
            {% if user_files %}
                {% for file in user_files %}
                    <div class="file-item">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-name">{{ file.filename }}</div>
                        <div class="file-meta">
                            <p>Â§ßÂ∞è: {{ (file.file_size / 1024)|round(2) }} KB</p>
                            <p>‰∏ä‰º†Êó∂Èó¥: {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p>Áä∂ÊÄÅ: {{ 'ÂÖ¨ÂÖ±' if file.is_public else 'ÁßÅÊúâ' }}</p>
                        </div>
                        <div class="file-actions">
                            {% set ext = file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else '' %}
                            {% set editable_ext = ['txt', 'md', 'markdown', 'py', 'js', 'html', 'css', 'json', 'xml', 'yaml', 'yml', 'sh', 'bat', 'cmd', 'java', 'c', 'cpp', 'h', 'hpp', 'php', 'rb', 'go', 'rust', 'swift', 'kt'] %}
                            {% set archive_ext = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz'] %}
                            
                            {% if ext in archive_ext %}
                                <!-- ÂéãÁº©ÂåÖÂè™ÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ -->
                                <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">‰∏ãËΩΩ</a>
                            {% elif ext in editable_ext %}
                                <!-- ÂèØÁºñËæëÊñá‰ª∂ÊòæÁ§∫ÁºñËæëÊåâÈíÆ -->
                                <a href="{{ url_for('edit_file', file_id=file.id) }}" class="btn btn-primary">ÁºñËæë</a>
                                <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-success">‰∏ãËΩΩ</a>
                            {% else %}
                                <!-- ÂÖ∂‰ªñÊñá‰ª∂ÊòæÁ§∫È¢ÑËßàÂíå‰∏ãËΩΩÊåâÈíÆ -->
                                <a href="{{ url_for('preview_file', file_id=file.id) }}" class="btn btn-secondary">È¢ÑËßà</a>
                                <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">‰∏ãËΩΩ</a>
                            {% endif %}
                            <a href="{{ url_for('delete_file', file_id=file.id) }}" class="btn btn-danger" onclick="return confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºü')">Âà†Èô§</a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">ÊöÇÊó†‰∏™‰∫∫Êñá‰ª∂</p>
            {% endif %}
        </div>
    </div>

    <!-- ÂÖ¨ÂÖ±Êñá‰ª∂ÂàóË°® -->
    <div class="card">
        <h3>ÂÖ¨ÂÖ±Êñá‰ª∂</h3>
        <div class="file-list">
            {% if public_files %}
                {% for file in public_files %}
                    <div class="file-item">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-name">{{ file.filename }}</div>
                        <div class="file-meta">
                            <p>Â§ßÂ∞è: {{ (file.file_size / 1024)|round(2) }} KB</p>
                            <p>‰∏ä‰º†Êó∂Èó¥: {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <div class="file-actions">
                            {% set ext = file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else '' %}
                            {% set editable_ext = ['txt', 'md', 'markdown', 'py', 'js', 'html', 'css', 'json', 'xml', 'yaml', 'yml', 'sh', 'bat', 'cmd', 'java', 'c', 'cpp', 'h', 'hpp', 'php', 'rb', 'go', 'rust', 'swift', 'kt'] %}
                            {% set archive_ext = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz'] %}
                            
                            {% if ext in archive_ext %}
                                <!-- ÂéãÁº©ÂåÖÂè™ÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ -->
                                <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">‰∏ãËΩΩ</a>
                            {% elif ext in editable_ext %}
                                <!-- ÂèØÁºñËæëÊñá‰ª∂ÊòæÁ§∫ÁºñËæëÊåâÈíÆ -->
                                <a href="{{ url_for('edit_file', file_id=file.id) }}" class="btn btn-primary">ÁºñËæë</a>
                                <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-success">‰∏ãËΩΩ</a>
                            {% else %}
                                <!-- ÂÖ∂‰ªñÊñá‰ª∂ÊòæÁ§∫È¢ÑËßàÂíå‰∏ãËΩΩÊåâÈíÆ -->
                                <a href="{{ url_for('preview_file', file_id=file.id) }}" class="btn btn-secondary">È¢ÑËßà</a>
                                <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">‰∏ãËΩΩ</a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">ÊöÇÊó†ÂÖ¨ÂÖ±Êñá‰ª∂</p>
            {% endif %}
        </div>
    </div>
{% endblock %}
