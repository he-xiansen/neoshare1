{% extends 'new_base.html' %}

{% block content %}
    <!-- æœç´¢æ¡† -->
    <div class="search-container">
        <form method="GET" action="{{ url_for('search') }}" style="width: 100%; display: flex; gap: 1rem;">
            <input type="text" name="q" placeholder="æœç´¢æ–‡ä»¶..." class="search-input" value="{{ request.args.get('q', '') }}">
            <button type="submit" class="btn btn-primary">æœç´¢</button>
        </form>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼  -->
    <div class="card">
        <h3>ä¸Šä¼ æ–‡ä»¶</h3>
        <form method="POST" action="/upload" enctype="multipart/form-data" class="upload-form">
            <div id="drag-drop-area" style="border: 2px dashed var(--accent-purple); border-radius: 10px; padding: 3rem; text-align: center; margin-bottom: 1rem; transition: all 0.3s ease;">
                <label for="file-upload" class="upload-label">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„
                </label>
                <input type="file" id="file-upload" name="file" required style="display: none;">
                <div id="file-info" style="margin: 1rem 0; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 5px; display: none;">
                    <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong>
                    <span id="selected-filename"></span>
                </div>
            </div>
            <br>
            <div class="checkbox-container">
                <input type="checkbox" id="is-public" name="is_public">
                <label for="is-public">è®¾ä¸ºå…¬å…±æ–‡ä»¶</label>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">ä¸Šä¼ æ–‡ä»¶</button>
        </form>
    </div>

    <script>
        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        const dragDropArea = document.getElementById('drag-drop-area');
        const fileInput = document.getElementById('file-upload');
        const fileInfo = document.getElementById('file-info');
        const selectedFilename = document.getElementById('selected-filename');
        
        if (dragDropArea && fileInput && fileInfo && selectedFilename) {
            // æ‹–æ‹½äº‹ä»¶å¤„ç†
            dragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragDropArea.style.borderColor = 'var(--accent-pink)';
                dragDropArea.style.backgroundColor = 'rgba(255, 107, 157, 0.1)';
            });
            
            dragDropArea.addEventListener('dragleave', () => {
                dragDropArea.style.borderColor = 'var(--accent-purple)';
                dragDropArea.style.backgroundColor = 'transparent';
            });
            
            dragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragDropArea.style.borderColor = 'var(--accent-purple)';
                dragDropArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    fileInput.files = e.dataTransfer.files;
                    selectedFilename.textContent = file.name;
                    fileInfo.style.display = 'block';
                }
            });
            
            // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
            dragDropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    selectedFilename.textContent = file.name;
                    fileInfo.style.display = 'block';
                } else {
                    selectedFilename.textContent = '';
                    fileInfo.style.display = 'none';
                }
            });
        }
    </script>

    <!-- ä¸ªäººæ–‡ä»¶åˆ—è¡¨ -->
    <div class="card">
        <h3>æˆ‘çš„æ–‡ä»¶</h3>
        <div class="file-list">
            {% if user_files %}
                {% for file in user_files %}
                    <div class="file-item">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-name">{{ file.filename }}</div>
                        <div class="file-meta">
                            <p>å¤§å°: {{ (file.file_size / 1024)|round(2) }} KB</p>
                            <p>ä¸Šä¼ æ—¶é—´: {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p>çŠ¶æ€: {{ 'å…¬å…±' if file.is_public else 'ç§æœ‰' }}</p>
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('preview_file', file_id=file.id) }}" class="btn btn-secondary">é¢„è§ˆ</a>
                            {% set ext = file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else '' %}
                            {% if ext in ['txt', 'md', 'markdown', 'py', 'js', 'html', 'css', 'json', 'xml', 'yaml', 'yml', 'sh', 'bat', 'cmd'] %}
                                <a href="{{ url_for('edit_file', file_id=file.id) }}" class="btn btn-primary">ç¼–è¾‘</a>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-success">ä¸‹è½½</a>
                            <a href="{{ url_for('delete_file', file_id=file.id) }}" class="btn btn-danger" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')">åˆ é™¤</a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">æš‚æ— ä¸ªäººæ–‡ä»¶</p>
            {% endif %}
        </div>
    </div>

    <!-- å…¬å…±æ–‡ä»¶åˆ—è¡¨ -->
    <div class="card">
        <h3>å…¬å…±æ–‡ä»¶</h3>
        <div class="file-list">
            {% if public_files %}
                {% for file in public_files %}
                    <div class="file-item">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-name">{{ file.filename }}</div>
                        <div class="file-meta">
                            <p>å¤§å°: {{ (file.file_size / 1024)|round(2) }} KB</p>
                            <p>ä¸Šä¼ æ—¶é—´: {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('preview_file', file_id=file.id) }}" class="btn btn-secondary">é¢„è§ˆ</a>
                            <a href="{{ url_for('download_file', filename=file.filepath.replace('uploads_new/', '')) }}" class="btn btn-primary">ä¸‹è½½</a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">æš‚æ— å…¬å…±æ–‡ä»¶</p>
            {% endif %}
        </div>
    </div>
{% endblock %}
